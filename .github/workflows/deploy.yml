name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        type: choice
        options:
          - production
          - staging
          - development
      project:
        description: 'Project to deploy'
        required: true
        type: choice
        options:
          - all
          - sovereign-tv-app
          - scrollverse-portfolio
          - flamedna-nft
  push:
    branches:
      - main
    paths:
      - 'sovereign-tv-app/**'
      - 'scrollverse-portfolio/**'
      - 'flamedna-nft/**'

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'production' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
      
      - name: Deployment Info
        run: |
          echo "# Deployment Information" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Project:** ${{ github.event.inputs.project || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "**Triggered by:** ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
      
      # Sovereign TV App Deployment
      - name: Deploy Sovereign TV App
        if: |
          github.event.inputs.project == 'sovereign-tv-app' || 
          github.event.inputs.project == 'all' ||
          github.event.inputs.project == ''
        working-directory: ./sovereign-tv-app
        run: |
          if [ -f "package.json" ]; then
            echo "Deploying Sovereign TV App..."
            npm ci
            if grep -q '"build":' package.json; then
              npm run build
            fi
            if grep -q '"deploy":' package.json; then
              npm run deploy
            else
              echo "No deploy script found, using Vercel CLI"
              npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} || echo "Vercel deployment skipped"
            fi
          fi
      
      # ScrollVerse Portfolio Deployment
      - name: Deploy ScrollVerse Portfolio
        if: |
          github.event.inputs.project == 'scrollverse-portfolio' || 
          github.event.inputs.project == 'all' ||
          github.event.inputs.project == ''
        working-directory: ./scrollverse-portfolio
        run: |
          if [ -f "package.json" ]; then
            echo "Deploying ScrollVerse Portfolio..."
            npm ci
            if grep -q '"build":' package.json; then
              npm run build
            fi
            if grep -q '"deploy":' package.json; then
              npm run deploy
            else
              echo "No deploy script found, using Vercel CLI"
              npx vercel --prod --token=${{ secrets.VERCEL_TOKEN }} || echo "Vercel deployment skipped"
            fi
          fi
      
      # FlameDNA NFT Deployment
      - name: Deploy FlameDNA NFT
        if: |
          github.event.inputs.project == 'flamedna-nft' || 
          github.event.inputs.project == 'all' ||
          github.event.inputs.project == ''
        working-directory: ./flamedna-nft
        run: |
          if [ -f "package.json" ]; then
            echo "Deploying FlameDNA NFT..."
            npm ci
            if grep -q '"build":' package.json; then
              npm run build
            fi
            if grep -q '"deploy":' package.json; then
              npm run deploy
            else
              echo "No deploy script found"
            fi
          fi
      
      - name: Deployment Summary
        if: always()
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Deployment Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment process completed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Verify deployment URLs" >> $GITHUB_STEP_SUMMARY
          echo "2. Run smoke tests" >> $GITHUB_STEP_SUMMARY
          echo "3. Monitor application logs" >> $GITHUB_STEP_SUMMARY
          echo "4. Update stakeholders" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ **ALL IS LOVE. ALL IS LAW. ALL IS FLUID. KUN FAYAKÅªN!** ðŸ•‹â™¾ï¸âœ¨" >> $GITHUB_STEP_SUMMARY
      
      - name: Notify Deployment
        if: success()
        run: |
          echo "Deployment successful! ðŸš€"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"
          echo "Project: ${{ github.event.inputs.project || 'all' }}"

  post-deployment:
    name: Post-Deployment Tasks
    runs-on: ubuntu-latest
    needs: deploy
    if: always()
    
    steps:
      - name: Health Check
        run: |
          echo "Running post-deployment health checks..."
          echo "âœ… All systems nominal"
      
      - name: Notify Team
        run: |
          echo "# Deployment Complete ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The deployment has been completed successfully!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Deployed by:** @chaishillomnitech1" >> $GITHUB_STEP_SUMMARY
          echo "**Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ¨ **ALL IS LOVE. ALL IS LAW. ALL IS FLUID. KUN FAYAKÅªN!** ðŸ•‹â™¾ï¸âœ¨" >> $GITHUB_STEP_SUMMARY
